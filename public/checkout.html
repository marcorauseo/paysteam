
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Conferma Pagamento</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f9f9f9; }
    h1 { color: #0077b6; }
    .info { margin-bottom: 20px; }
    button { padding: 10px 16px; margin-right: 10px; }
  </style>
</head>
<body>
    <script>
    const jwt = localStorage.getItem('token');
    if (!jwt) {
      document.body.innerHTML = `
        <h2>‚ö†Ô∏è Autenticazione richiesta</h2>
        <p>Per procedere con il pagamento, effettua prima il <strong>login</strong> o la <strong>registrazione</strong>.</p>
        <button onclick="window.location.href='/index.html'">Vai al login</button>
      `;
      throw new Error('Accesso negato: token assente');
    }
  </script>
  <h1>Checkout PaySteam</h1>
  <div class="info">
    <p><strong>Utente:</strong> <span id="email"></span></p>
    <p><strong>Prezzo:</strong> ‚Ç¨<span id="prezzo"></span></p>
    <p><strong>Descrizione:</strong> <span id="desc"></span></p>
    <p><strong>Saldo attuale:</strong> ‚Ç¨<span id="saldo"></span></p>
    <p id="errore" style="color:red;"></p>
  </div>
  <button onclick="paga()">‚úÖ Conferma</button>
  <button onclick="annulla()">‚ùå Annulla</button>

<script>
  const params = new URLSearchParams(location.search);
  const id = params.get('id');
  const callback = params.get('callback');
  const prezzo = parseFloat(params.get('prezzo'));
  const desc = params.get('desc');
  const email = params.get('email') || localStorage.getItem('paysteam_email');

  document.getElementById('email').textContent = email;
  document.getElementById('prezzo').textContent = prezzo.toFixed(2);
  document.getElementById('desc').textContent = desc;

  async function caricaSaldo() {
     try {
      const res = await fetch('/api/saldo?email=' + encodeURIComponent(email));
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Errore saldo');
      const saldoNum = parseFloat(data.saldo);
      if (isNaN(saldoNum)) throw new Error('Saldo non valido');
      if (saldoNum < 0) throw new Error('Saldo negativo non consentito');
      document.getElementById('saldo').textContent = saldoNum.toFixed(2);
      if (data.saldo < prezzo) {
        document.getElementById('errore').textContent = 'Saldo insufficiente per procedere.';
        document.querySelector('button[onclick="paga()"]').disabled = true;
      }
    } catch (err) {
      document.getElementById('errore').textContent = err.message;
    }
  }

  async function paga() {
    try {
      const res = await fetch('/api/scalasaldo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, importo: prezzo })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Errore pagamento');

      // üîÅ Redirect a conferma pagamento con parametri
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/pay/confirm';

      const ok = document.createElement('input');
      ok.name = 'ok';
      ok.value = '1';

      const cb = document.createElement('input');
      cb.name = 'callback_url';
      cb.value = callback;

      const tx = document.createElement('input');
      tx.name = 'id_transazione';
      tx.value = id;

      [ok, cb, tx].forEach(el => form.appendChild(el));
      document.body.appendChild(form);
      form.submit();
    } catch (err) {
      document.getElementById('errore').textContent = err.message;
    }
  }


function annulla() {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/pay/cancel';
    document.body.appendChild(form);
    form.submit();
  }

  caricaSaldo();
</script>
</body>
</html>
